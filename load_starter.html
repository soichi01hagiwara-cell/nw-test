<!DOCTYPE html>
<html>
<head>
    <title>ネットワーク負荷試験</title>
    <meta charset="UTF-8">

    <!-- Google tag (gtag.js) - アクセス数計測用 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NKLN0CBQ8N"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NKLN0CBQ8N');
    </script>
    
    <style>
        /* 📌 ボディ全体に単語の強制折り返しを適用し、横スクロールを抑制 */
        body {
            word-wrap: break-word; 
            overflow-wrap: break-word;
            font-family: sans-serif;
            padding: 10px; /* 画面端に近すぎないように余白を追加 */
        }
        #downloadButton {
            /* 文字サイズを大きく */
            font-size: 24px; 
            /* ボタンの上下左右の余白を大きく */
            padding: 15px 30px; 
            /* ボタンの角を少し丸く */
            border-radius: 8px; 
            /* ボタンの色を目立つように */
            background-color: #4CAF50; 
            color: white;
            border: none;
            cursor: pointer;
        }
        /* ボタンが無効化されたとき（30秒間）のスタイル */
        #downloadButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h1>校内ネットワーク負荷試験を開始します</h1>
    
    <p style="font-size: 1.2em; color: blue; font-weight: bold;">
        【重要】試験開始の放送があるまで、ダウンロードしないで待機してください。<br>
        　　また、この画面以外のタブはすべて閉じてください（想定外のネットワーク負荷を防止するため）
    </p>
    
    <p>ボタンを押すごとにファイルが**1つ**ダウンロードされ、ネットワークに負荷をかけます。次のダウンロードまで**30秒**待つ必要があります。<br>
    また、ファイルは1つずつダウンロードしてください。ファイルダウンロード途中で下記ボタンが有効になっても、押さないでください。</p>
    
    <h2 id="downloadStatus">現在のダウンロード回数: 0 回</h2>

    <button id="downloadButton" onclick="downloadSingleFile()">
        負荷開始 (ダウンロード)：放送の指示があるまで押さない
    </button>
    
    <p id="countdownMessage" style="color: red; font-weight: bold;"></p>
    
    <hr>
    
    <!-- アンケート関連情報 -->
    <p>
        試験終了後のアンケートに、ダウンロードできたファイルの数を報告してください。<br>
        ダウンロードしたファイルは、乱数が入っているだけの意味の無いファイルですので、試験終了後に削除してください。
    </p>
    <p>
        試験終了の放送が入ったら、次のリンクを押して、アンケートに回答してください（試験不参加者も含む）：<br>
        <b><a href="https://docs.google.com/forms/d/e/1FAIpQLScT8Qf9IdCbnP-YtXgnj7OTlTfpfGCcxeEZgJbw_QcGzbI83w/viewform?usp=header" target="_blank">
            ネットワーク負荷試験報告フォーム
        </a></b><br>
    </p>
    <p>
        スマホ用QRコード：<br>
        <img src="qr.png" alt="ネットワーク負荷試験報告フォーム" style="max-width: 150px; height: auto;">
    </p>

    <hr>
    
    <!-- ネットワーク負荷試験の詳細【待ち時間中、暇な人用読み物】 -->
    <p style="font-size: 1.2em; color: blue; font-weight: bold;">ネットワーク負荷試験の詳細【待ち時間中、暇な人用読み物】</p>

    <p>
        この負荷試験は、将来の<strong>大学入学共通テスト（CBT）</strong>の予行としても楽しめます。以下のデータを確認し、実際の状況と比較してみると、校内ネットワークへの理解が深まります。
    </p>

    <ul>
        <li><strong>本校の最大スループット（インターネット回線）：</strong> 200 Mbps (メガビット/秒)</li>
        <li><strong>試験用ファイルサイズ：</strong> 20 MB (メガバイト) = 160 Mbit (メガビット)</li>
    </ul>

    <h3>理論値の検証：ほぼ全生徒が参加した場合（1,000名）</h3>
    <p>
        理論的に1,000名が同時にダウンロードを開始した場合、公平に帯域が分配されると、生徒一人あたりに割り当てられる帯域は次のようになります:
    </p>
    <p>
        200 Mbps ÷ 1,000人 = <strong>0.2 Mbps/人</strong>
    </p>
    <p>
        この速度（0.2 Mbps）で160 Mbitのファイルをダウンロードするのにかかる時間は、以下のようになります:
    </p>
    <p>
        160 Mbit ÷ 0.2 Mbps = 800 秒（約 <strong>13.3分</strong>）
    </p>
    <p>
        したがって、<strong>理想的な環境でも、試験時間内にダウンロードできる人数はゼロに近づく</strong>という計算になります。
    </p>

    <p>
        ※ しかし、この間の特別講義の冬服着用率を見るに、同時参加人数は良くて700名程度と予想しています。概ね1つはダウンロードが可能であると考えています。
    </p>

    <p style="font-size: 1.1em; font-weight: bold;">
        【暇つぶし問題】同時参加が700名だったら、1つのファイルをダウンロードするのにかかる時間は？
    </p>
    <p>
        端数が出ますので電卓で計算を推奨します　➡ 答えは白抜き：
        <font color="#FFFFFF">
            <strong>9.3分 (約 560秒)</strong>
        </font>
    </p>
    <p style="margin-top: -1em;">
        <small>（計算のヒント: 200Mbps ÷ 700人 ≒ ??? Mbps/人。 160 Mbit ÷ ??? Mbps ≒ ???秒）</small>
    </p>

    <h3>重要事項：負荷試験の意義</h3>
    <p>
        今回の試験の成功の鍵は、**理論上の計算（理想値）**と**実際の参加人数・ダウンロード成功回数（実測値）**がどれだけ一致するか、または乖離するかを比較することにあります。
    </p>
    <p style="color: red; font-weight: bold;">
        ですので、「参加人数」と「ダウンロードできた回数」を正確に知る必要があります！　アンケートは不参加者を含め、全員の回答が必要です。
    </p>
    <hr>
    
    <div id="iframeContainer"></div>

    <script>
        // 設定パラメータ
        // 【注意】TARGET_URLは、あなたのリポジトリのURLに合わせて修正してください。
        const TARGET_URL = "https://s01prefshizuoka.github.io/nw-test/testfile.zip";
        const DISABLE_DURATION_MS = 30000; // 30秒間無効化 (30000ms)
        // -----------------------------------------------------------------------

        let downloadCount = 0;
        let countdownInterval;

        function updateStatus() {
            document.getElementById('downloadStatus').textContent = `現在のダウンロード回数: ${downloadCount} 回`;
        }
        
        function startCountdown(duration) {
            let seconds = duration / 1000;
            const messageElement = document.getElementById('countdownMessage');

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                if (seconds > 0) {
                    messageElement.textContent = `次の負荷開始まで ${seconds} 秒待機してください...`;
                    seconds--;
                } else {
                    clearInterval(countdownInterval);
                    // 30秒経過後のメッセージを修正（ユーザーの意図を反映）
                    messageElement.textContent = 'ダウンロードが完了していたら、ボタンを押して追加の負荷をかけてください。（ファイルダウンロード中は押さなくて良いです）';
                }
            }, 1000);
        }


        function downloadSingleFile() {
            const button = document.getElementById('downloadButton');
            
            // 1. ボタンを無効化
            button.disabled = true;
            button.textContent = '負荷処理中...';

            downloadCount++;
            updateStatus(); // 回数表示を更新

            const container = document.getElementById('iframeContainer');
            
            // 2. ダウンロード処理のトリガー
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none'; 
            
            // キャッシュを防ぐため、URLにランダムなクエリパラメータを追加
            iframe.src = TARGET_URL + '?r=' + Math.random();
            
            container.appendChild(iframe);
            
            // カウントダウンを開始
            startCountdown(DISABLE_DURATION_MS);
            
            // 3. 30秒後にボタンを再有効化する
            setTimeout(() => {
                button.disabled = false;
                button.textContent = '負荷開始 (ダウンロード)';
                document.getElementById('countdownMessage').textContent = '次の負荷を開始可能です！';
            }, DISABLE_DURATION_MS);
        }
        
        window.onload = updateStatus;
    </script>

</body>
</html>
