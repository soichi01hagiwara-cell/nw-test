<!DOCTYPE html>
<html>
<head>
    <title>ネットワーク負荷試験スタート</title>
    <meta charset="UTF-8">
    
    <style>
        #downloadButton {
            /* 文字サイズを大きく */
            font-size: 24px; 
            /* ボタンの上下左右の余白を大きく */
            padding: 15px 30px; 
            /* ボタンの角を少し丸く */
            border-radius: 8px; 
            /* ボタンの色を目立つように */
            background-color: #4CAF50; 
            color: white;
            border: none;
            cursor: pointer;
        }
        /* ボタンが無効化されたとき（30秒間）のスタイル */
        #downloadButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h1>校内ネットワーク負荷試験を開始します</h1>
    
    <p style="font-size: 1.2em; color: blue; font-weight: bold;">
        【重要】試験開始の放送があるまで、ダウンロードしないで待機してください。
    </p>
    
    <p>ボタンを押すごとにファイルが**1つ**ダウンロードされ、ネットワークに負荷をかけます。次のダウンロードまで**30秒**待つ必要があります。<br>
    また、ファイルは1つずつダウンロードしてください。</p>
    
    <h2 id="downloadStatus">現在のダウンロード回数: 0 回</h2>

    <button id="downloadButton" onclick="downloadSingleFile()">
        負荷開始 (ダウンロード)
    </button>
    
    <p id="countdownMessage" style="color: red; font-weight: bold;"></p>
    
    <hr>
    
    <p>
        試験終了後のアンケートに、ダウンロードできたファイルの数を報告してください。<br>
        ダウンロードしたファイルは、試験終了後、削除してください。
    </p>
    <p>
        アンケートはこちらから：
        <a href="https://docs.google.com/forms/d/e/1FAIpQLScT8Qf9IdCbnP-YtXgnj7OTlTfpfGCcxeEZgJbw_QcGzbI83w/viewform?usp=header" target="_blank">
            試験終了報告アンケートフォーム
        </a>
    </p>

    <div id="iframeContainer"></div>

    <script>
        // 設定パラメータ
        const TARGET_URL = "https://s01prefshizuoka.github.io/nw-test/testfile.zip";
        const DISABLE_DURATION_MS = 30000; // 30秒間無効化 (30000ms)
        // -----------------------------------------------------------------------

        let downloadCount = 0;
        let countdownInterval;

        function updateStatus() {
            document.getElementById('downloadStatus').textContent = `現在のダウンロード回数: ${downloadCount} 回`;
        }
        
        function startCountdown(duration) {
            let seconds = duration / 1000;
            const messageElement = document.getElementById('countdownMessage');

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                if (seconds > 0) {
                    messageElement.textContent = `次の負荷開始まで ${seconds} 秒待機してください...`;
                    seconds--;
                } else {
                    clearInterval(countdownInterval);
                    messageElement.textContent = '次の負荷を開始可能です！';
                }
            }, 1000);
        }


        function downloadSingleFile() {
            const button = document.getElementById('downloadButton');
            
            // 1. ボタンを無効化
            button.disabled = true;
            button.textContent = '負荷処理中...';

            downloadCount++;
            updateStatus(); // 回数表示を更新

            const container = document.getElementById('iframeContainer');
            
            // 2. ダウンロード処理のトリガー
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none'; 
            
            // キャッシュを防ぐため、URLにランダムなクエリパラメータを追加
            iframe.src = TARGET_URL + '?r=' + Math.random();
            
            container.appendChild(iframe);
            
            // カウントダウンを開始
            startCountdown(DISABLE_DURATION_MS);
            
            // 3. 30秒後にボタンを再有効化する
            setTimeout(() => {
                button.disabled = false;
                button.textContent = '負荷開始 (1ファイル)';
                document.getElementById('countdownMessage').textContent = '次の負荷を開始可能です！';
            }, DISABLE_DURATION_MS);
        }
        
        window.onload = updateStatus;
    </script>

</body>
</html>

